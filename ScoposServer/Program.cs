// ============================================================================
// ПРОГРАММНЫЙ ФАЙЛ ЗАПУСКА ASP.NET CORE WEB API
// ============================================================================

// Подключение Entity Framework Core - ORM для работы с базой данных
using Microsoft.EntityFrameworkCore;
// Подключение контекста базы данных нашего приложения
using ScoposServer.Data;

// ============================================================================
// 1. ИНИЦИАЛИЗАЦИЯ WEB APPLICATION BUILDER
// ============================================================================

// Создаем строителя веб-приложения, который будет конфигурировать все сервисы
var builder = WebApplication.CreateBuilder(args);

// ============================================================================
// 2. РЕГИСТРАЦИЯ СЕРВИСОВ В КОНТЕЙНЕР ВНЕДРЕНИЯ ЗАВИСИМОСТЕЙ (DI)
// ============================================================================

// Добавляем поддержку контроллеров для обработки HTTP запросов
builder.Services.AddControllers();

// Добавляем API Explorer для генерации метаданных о эндпоинтах
builder.Services.AddEndpointsApiExplorer();

// Добавляем Swagger для автоматической генерации документации API
builder.Services.AddSwaggerGen();

// ============================================================================
// 3. НАСТРОЙКА AUTOMAPPER ДЛЯ МАППИНГА МЕЖДУ DTO И СУЩНОСТЯМИ
// ============================================================================
builder.Services.AddAutoMapper(cfg =>
{
    // Автоматически сканируем все сборки и находим все профили AutoMapper
    // (классы, наследующие Profile из пространства имен AutoMapper)
    cfg.AddMaps(AppDomain.CurrentDomain.GetAssemblies());
});

// ============================================================================
// 4. НАСТРОЙКА CORS (CROSS-ORIGIN RESOURCE SHARING)
// ============================================================================
builder.Services.AddCors(options =>
{
    // Создаем политику CORS с именем "AllowLocalhost"
    options.AddPolicy("AllowLocalhost",
        policy =>
        {
            // Разрешаем запросы только с указанных доменов:
            // - Продуктивные сервера приложения
            // - Локальный фронтенд на React/Vue (порты 5173)
            policy.WithOrigins(
                    "http://srv-edms-scopos.ufa-tr.gazprom.ru",
                    "https://srv-edms-scopos.ufa-tr.gazprom.ru",
                    "https://localhost:5173",
                    "http://localhost:5173")
                  // Разрешаем любые заголовки в запросах
                  .AllowAnyHeader()
                  // Разрешаем любые HTTP методы (GET, POST, PUT, DELETE и т.д.)
                  .AllowAnyMethod()
                  // Разрешаем передачу куки и заголовков авторизации
                  .AllowCredentials();
        });
});

// ============================================================================
// 5. НАСТРОЙКА ПОДКЛЮЧЕНИЯ К БАЗЕ ДАННЫХ POSTGRESQL
// ============================================================================
builder.Services.AddDbContext<AppDbContext>(options =>
    // Используем провайдер Npgsql для PostgreSQL
    // Строка подключения берется из файла конфигурации (appsettings.json)
    options.UseNpgsql(builder.Configuration.GetConnectionString("Default")));

// ============================================================================
// 6. ПОСТРОЕНИЕ ПРИЛОЖЕНИЯ
// ============================================================================
var app = builder.Build();

// ============================================================================
// 7. НАСТРОЙКА КОНВЕЙЕРА ОБРАБОТКИ HTTP ЗАПРОСОВ (MIDDLEWARE PIPELINE)
// ============================================================================

// Проверяем режим работы приложения
if (app.Environment.IsDevelopment())
{
    // В режиме разработки включаем Swagger для тестирования API
    app.UseSwagger();
    app.UseSwaggerUI();
}

// Перенаправляем HTTP запросы на HTTPS
app.UseHttpsRedirection();

// Применяем политику CORS, которую настроили выше
app.UseCors("AllowLocalhost");

// Добавляем middleware авторизации
// (проверка прав доступа для аутентифицированных пользователей)
app.UseAuthorization();

// ============================================================================
// 8. МАППИНГ КОНТРОЛЛЕРОВ
// ============================================================================
// Связываем маршруты (routes) с методами контроллеров
app.MapControllers();

// ============================================================================
// 9. ЗАПУСК ПРИЛОЖЕНИЯ
// ============================================================================
// Запускаем веб-сервер и начинаем обрабатывать входящие запросы
app.Run();